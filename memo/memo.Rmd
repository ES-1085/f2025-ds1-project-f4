---
title: "Project memo"
author: "Team name"
output: github_document
---

This document should contain a detailed account of the data clean up for your data and the design choices you are making for your plots. For instance you will want to document choices you've made that were intentional for your graphic, e.g. color you've chosen for the plot. Think of this document as a code script someone can follow to reproduce the data cleaning steps and graphics in your handout.

```{r load-packages, message = FALSE}
#install.packages(c("gganimate", "sf","viridis", "av"))
#install.packages("WDI")
#install.packages("countrycode")  
library(WDI)
library(countrycode)
library(tidyverse)
library(broom)
library(gganimate)
library(ggplot2)
library(dplyr)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)  
library(skimr)
library(stringr)
library(RColorBrewer)
library(htmltools)
library(leafsync)
library(leaflet)
library(kableExtra)
library(av)
```

## Data Clean Up Steps for Overall Data

### Step 1: 
In this project, we use Varieties of Democracy (V-Dem) dataset and World Development Indicators (WDI) dataset of the World Bank. Because of the size of V-Dem dataset, we had to merge both the dataset outside Posit. The following shows how we do this. We then rename variables in our main dataset df. Here, we observe `r ncol(df)` variables and `r nrow(df)` observations.

```{r data-clean}
df <- read_csv("../data/vdem3.csv")
vdem2 <- df %>% 
   select(country_name,
          histname,
          historical_date,
          year,
          country_text_id,
          country_id,
          v2x_polyarchy,
          v2x_libdem,
          v2x_partipdem,
          v2x_delibdem,
          v2x_egaldem) 
 
 data <- WDI(
   country = "all",
   indicator = c(
     "NY.GDP.PCAP.CD",  
     "NY.GDP.MKTP.CD",  
     "SP.POP.TOTL",     
     "SI.POV.GINI"     
   ),
  start = 1960,
   end = 2024,
   extra = TRUE   )
 
 WDI_data <- data %>%
   rename(
     gdp_per_capita = NY.GDP.PCAP.CD,
     gdp = NY.GDP.MKTP.CD,
     population = SP.POP.TOTL,
     gini = SI.POV.GINI,
     iso3c = iso3c,
     region = region,
     country_name = country
   ) %>%
   mutate(
     continent = countrycode(iso3c, origin = "iso3c", destination = "continent")
   ) %>%

   select(year, country_name, iso3c, gdp_per_capita, gdp, population, gini, region, continent)

 df <- right_join(vdem2, WDI_data, by = c("country_name", "year"))
 
 df <- df %>% 
  rename(polyarchy = v2x_polyarchy, 
         libdem = v2x_libdem, 
         delibdem = v2x_delibdem,
         partidem = v2x_partipdem,
         egaldem = v2x_egaldem, 
         countryid = country_text_id,
         gdppc = gdp_per_capita
         )
 df %>% 
  glimpse()
```

### Step 2: 
We answer our research question using basic visualizations of correlations without considering covariates. To do this we use the following variables: `country`, `year`, `countryid`, `polyarchy`, `libdem`, `partipdem`, `delibdem`, `egaldem`, `gdp`, `gdppc`, `population`, `region`, `continent`, and `gini`.

Most of our analyses will include three main variables: `year`, the measures of democracy (`polyarchy`, `libdem`, `partipdem`, `delibdem`, `egaldem`), and measures of economic development (`gdppc` and `gini`). 

Definitions of Democracy Indices

(1) Polyarchy, also known as electoral democracy, is the extent to which elections are free, fair, and inclusive, and whether key democratic institutions allow citizens to choose their leaders meaningfully.

(2) Liberal democracy, on the other hand, is the extent to which individual rights, rule of law, and constraints on executive power protect citizens from government abuse. It is also the most common conception of democracy in the West. 

(3) Deliberative democracy measures whether political decisions are made through reasoned, respectful, and common-good–oriented public deliberation rather than elite coercion or narrow interests.

(4) Participatory Democracy measures how much citizens can directly participate in political processes through civil society, local governance, and non-electoral channels.

(5) Lastly, egalitarian democracy measures the extent to which political power and influence are distributed equally across social groups, ensuring equal access to rights and resources.

These measures are the product of a series of questions answered by experts of about five in each country. These questions are then turned into indices using Bayesian aggregation. These measures are important in representing democracy as they capture the different and often debated definitions of democracy.

To further illustrate this, we plan to use the following visualizations:

1. Time-series Plot - This will shows how the measures of democracy (`polyarchy`, `libdem`, `partipdem`, `delibdem`, `egaldem`) and measures of economic development (`gdppc` and `gini`) evolved through time. In the same visualization, we will also include lines that describe any particular events that explains the increase or drop of both measures. We can also facet this to show how the relationship differs (if at all) with respect to `region`.

2. Animated Maps - This is another way to show how the measures of democracy (`polyarchy`, `libdem`, `partipdem`, `delibdem`, `egaldem`) and measures of economic development (`gdppc` and `gini`) evolved through time while also considering the `country` in a map. 

3. Scatter Plot and Heatmaps- This plot is the most important of all. This finally shows the bivariate relationship between economic development and democracy. One way to show this is by transforming the x-axis to the percentile of countries' economic development and y-axis to the percentile of countries in terms of a measure of democracy. We will then facet them in terms of the measures of democracy (`polyarchy`, `libdem`, `partipdem`, `delibdem`, `egaldem`). This transformation is necessary, because as you will see below, the distribution of the economic indicator is highly skewed (although we may also use the log function).


## Plots:

#### Data cleanup steps specific to plot 1

These data cleaning sections are optional and depend on if you have some data cleaning steps specific to a particular plot

```{r data_clean_opt}
#df <- df %>% 
 # rename(polyarchy = v2x_polyarchy, 
  #       libdem = v2x_libdem, 
   #      delibdem = v2x_delibdem,
    #     partidem = v2x_partipdem,
     #    egaldem = v2x_egaldem, 
      #   countryid = country_text_id,
       #1  gdppc = gdp_per_capita)

```


#### Final Plot 1
This plot shows the change in Democracy and GDP per capita over time. We can see that after the Third Wave of Democratization, which shifted from authoritarian regimes to democratic governments, there is an almost instant increase in democratization, shortly followed by a rise in GDP per capita. This data shows that once a country has become more democratic, its economy begins to increase shortly after.

```{r line-plot, fig.alt = “Line plot of aggregated countries' median indices of democracy and GDP per capita from 1960 to 2024 with annotation of Third Wave Democratization. The growth of democracy is associated with economic growth.”}
df_year <- df %>%
  group_by(year) %>%
  summarise(
    Polyarchy = median(polyarchy, na.rm = TRUE),
    `Liberal Democracy` = median(libdem, na.rm = TRUE),
    `Deliberative Democracy` = median(delibdem, na.rm = TRUE),
    `Participatory Democracy` = median(partidem, na.rm = TRUE),
    `Egalitarian Democracy` = median(egaldem, na.rm = TRUE),
    `GDP Per Capita` = median(gdppc, na.rm = TRUE)
  )

df_long <- df_year %>%
  pivot_longer(
    cols = c(Polyarchy, `Liberal Democracy`, `Deliberative Democracy`, `Participatory Democracy`,  `Egalitarian Democracy`),
    names_to = "index",
    values_to = "value"
  )

df_long <- df_long %>%
  mutate(
    index = factor(
      index,
      levels = c(
        "Polyarchy",
        "Liberal Democracy",
        "Deliberative Democracy",
        "Participatory Democracy",
        "Egalitarian Democracy"
      )))


scale_factor <- max(df_year$`GDP Per Capita`, na.rm = TRUE) /
                max(df_long$value, na.rm = TRUE)

p1 <- ggplot(df_year, aes(x = year)) +
  geom_line(aes(y = `GDP Per Capita`, color = "GDP per capita"), size = 1.2) +
  geom_line(
    data = df_long,
    aes(y = value * scale_factor, color = index),
    size = 1.2
  ) +
  scale_y_continuous(
    name = "GDP per capita",
    sec.axis = sec_axis(~ . / scale_factor, name = "Democracy Indices")
  ) +
  labs(
    title = "Democracy and Economy (1960–2024)",
    x = "Year",
    color = "Variables",
    caption = "Source: V-Dem Dataset v13; World Bank World Development Indicators (GDP per capita) "
  ) +
  theme_minimal() +
  scale_color_viridis_d() +
  annotate("rect", 
  xmin = 1975, 
  xmax = 1990, 
  ymin = 0, 
  ymax = 8000, 
  alpha = 0.05, 
  fill = "#440154FF") +
   # geom_vline(xintercept = 1975, linetype = "dotted", color = "#440154FF") +
   # geom_vline(xintercept = 1990, linetype = "dotted", color = "#440154FF") +
   # geom_text(aes(x = 1966, y = 7000), 
   # label = "Third Wave \n Democratization", size = 3.5)
    geom_vline(xintercept = 1975, linetype = "dotted", color = "#440154FF") +
   geom_vline(xintercept = 1990, linetype = "dotted", color = "#440154FF") +
   annotate("text", 
         x = 1982, 
         y = 7000, 
         label = "Third Wave \n Democratization", 
         size = 3.2)


ggsave(filename = "plot_output/Democracy_vs_Economy.png", plot = p1, width = 6, height = 4)
```

In this plot, we use median as the measure of central tendency. This decision is guided by the fact that GDP per capita and measures of democracy are skewed, which makes mean unreliable. Moreover, in political science and economics, when dealing with aggregate data, scholars most often than not use median. 

### Plot 2: gdppc-across-time map and Liberal-democracy-across-time map
Since it take so much time to knit when generating mp4 files. We put the output link overhere. See over here: <https://drive.google.com/file/u/0/d/1QzBOESqxSqmxjJ7EiKZybSGOcYg-OGwN/view?usp=sharing&pli=1>
These maps show the GDP per capita and the World Liberal Democracy of the entire world in 2024. When comparing these maps side by side, we can see that in countries that are more democratic, we also see a better GDP per capita. When you scan the QR codes, you can also see the change in GDP per Capita and World Liberal Democracy over time (1960 - 2024). In these changing maps, we can also see the same pattern as in 2024.

```{r gdp-2024-map Eval = FALSE, fig.alt = “Choropleth map of GDP per capita in 2024. Economic growth is associated with Global North as opposed to Global South.”}
year_to_plot <- 2024
map_data_year <- df |> 
  filter(year == year_to_plot)

world <- ne_countries(scale = "medium", returnclass = "sf")

world_data <- world %>%
  left_join(map_data_year, by = c("iso_a3" = "country_text_id"))

ggplot(data = world_data) +
  geom_sf(aes(fill = gdppc), color = "gray30", size = 0.2) +
  scale_fill_viridis_c(na.value = "lightgray",
                       name = "GDP per Capita") +
  labs(
    title = paste("World GDP per Capita in", year_to_plot)
  ) +
  theme_minimal() +
  theme(
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  legend.position = "left",
  plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
)
```

``` {r gdppc-across-time-map Eval = FALSE, fig.alt = “Choropleth map of GDP per capita over time, from 1960 to 2024. Economy has been growing for many countries since 1960.”}

world <- ne_countries(scale = "medium", returnclass = "sf")

df_clean <- df %>%
  filter(year >= 1960, year <= 2024)

world_data <- world %>%
  left_join(df_clean, by = c("iso_a3" = "iso3c"))

p <- ggplot(world_data) +
  geom_sf(aes(fill = gdppc), color = "gray30", size = 0.2) +
  scale_fill_viridis_c(
    option = "plasma",
    na.value = "lightgray",
    name = "GDP per Capita",
    limits = c(0, 100000),   
  ) +
  labs(
    title = "World GDP per Capita",
    caption = "Source: V-Dem Dataset v13; World Bank WDI"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
  axis.ticks = element_blank(),
    legend.position = "left",
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  ) +
  transition_states(
    year,
    transition_length = 1,
    state_length = 1
  ) +
  ease_aes("linear")

animate(
  p,
  nframes = 200,
  fps = 10,
  width = 900,
  height = 600,
  renderer = av_renderer("world_gdppc_1960_2024.mp4")
)
```


```{r libdem-2024-map Eval = FALSE, fig.alt = “Choropleth map of Liberal Democracy index. North and South America, along with Europe and Oceania, are the most demoratic in terms of liberal democracy, while Africa and Asia are less democratic”}
year_to_plot <- 2024
map_data_year <- df |> 
  filter(year == year_to_plot)

world <- ne_countries(scale = "medium", returnclass = "sf")

world_data <- world %>%
  left_join(map_data_year, by = c("iso_a3" = "country_text_id"))

ggplot(data = world_data) +
  geom_sf(aes(fill = libdem), color = "gray30", size = 0.2) +
  scale_fill_viridis_c(na.value = "lightgray",
                       name = "Liberal Dem. Index") +
  labs(
    title = paste("World Liberal Democracy in", year_to_plot)
  ) +
  theme_minimal() +
  theme(
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  legend.position = "left",
  plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
)
```

``` {r libdem-across-time-map Eval = FALSE, fig.alt = “Choropleth map of Liberal Democracy index over time, from 1960 to 2024. Liberal democracy has been growing for many countries since 1960.”}
world <- ne_countries(scale = "medium", returnclass = "sf")

df <- df %>%
  filter(year >= 1960 & year <= 2024)

world_data <- world %>%
  left_join(df, by = c("iso_a3" = "iso3c"))

p <- ggplot(world_data) +
  geom_sf(aes(fill = libdem), color = "gray30", size = 0.2) +
  scale_fill_viridis_c(
    option = "plasma",
    na.value = "lightgray",
    name = "Liberal Democracy Rating"
  ) +
  labs(
    title = "World Liberal Democracy Rating: {closest_state}",
    caption = "Source: V-Dem Dataset v13"
  ) +
  theme_minimal() +
  theme(
    axis.text = element_blank(),
  axis.ticks = element_blank(),
    legend.position = "left",
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  ) +
  transition_states(
    year,
    transition_length = 1,
    state_length = 1
  ) +
  ease_aes("linear")

animate(
  p,
  nframes = 200,
  fps = 10,
  width = 900,
  height = 600,
  renderer = av_renderer("world_libdem_rating_1960_2024.mp4")
)
```

As you see, the years used in this plot are from 1960 to 2024. This years are not a product of arbitrary decision but of the data limitations. While the V-Dem dataset extend beyond that range, WDI dataset only provides 1960-2024. Moreover, we chose to represent the whole map in 2024 for it is the most recent year available in the data, and having the recent year represented is the least arbitrary, as one relates more to recent than the old conditions.

### Plot 3: Positive Relationship between Democracy and Economy (1960–2024)

These plots show the bivariate relationship between the percentile of indices of democracy and GDP per capita. We can observe here a strong positive relationship between
economy and democracy. Moreover, the concentration in the lower right of each plot shows what scholars call resource course, where because states have high amount of resources, they become less dependent on the people.

``` {r Relation_plot Eval = FALSE, fig.alt = “Heat map of GDP per capita and democracy indices percentile, from 1960 to 2024. Economy and democracy in all indices show a strong positive correlation, with high concentrations in the upper right.”}
df_percentiles <- df %>%
  mutate(
    `GDP Per Capita` = percent_rank(gdppc),
    Polyarchy = percent_rank(polyarchy), 
    Egalitarian = percent_rank(egaldem),
    Participatory = percent_rank(partidem),
    Liberal = percent_rank(libdem),
    Deliberative = percent_rank(delibdem)
  )

df_long <- df_percentiles %>%
  pivot_longer(
    cols = c(Polyarchy, Egalitarian, Participatory, Liberal, Deliberative),
    names_to = "metric",
    values_to = "percentile_value"
  )

p2 <- ggplot(df_long, aes(x = `GDP Per Capita`, y = percentile_value)) +
  geom_bin2d(bins = 40) +
  scale_fill_viridis_c() +
  facet_wrap(~ metric) +
  labs(
    y = "Democracy Index",
    title = "Positive Relationship between Democracy and Economy (1960–2024)",
    subtitle = "in Percentile",
    fill = "Count"
  ) +
  theme_minimal()

print(p2)

if(!dir.exists("output")) { dir.create("output") }

ggsave(filename = "output/Democracy_vs_Economy_Bin2d.png", 
       plot = p2, 
       width = 8, 
       height = 6)
```

In this plot, we decided to use each observation's percentile. Doing so allows us to show the relationship without accounting for skewed data (e.g., by log). It also standardizes the measures (i.e., from 0th to 100th).

## Conclusions and Limitations

In this project, we ask whether economy has effects on democracy. We use two datasets involving robust democracy and economy measures. Our visualization suggests that economy heavily influences democracy. That is, as economy rise, so does democracy in aggregate level. This is a strong visualization in support of fundamental theories in comparative politics, including economic modernization theory. 

Although we find that economy influences democracy, the plots alone do not show the causal mechanism driving this influence. It may also be the case that democracy predicts economy as we show in `Plot 1`. One necessary method to establish such claims is to use econometric models; however, doing so would go beyond the project's scope. 

Nonetheless, this project shows the important role of economy in democratization or democracy in economic growth. 
